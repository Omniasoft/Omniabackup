#!/usr/bin/php
<?php
class Omniashell
{
	// Settings
	public $version = '0.0.1';
	public $group = 'dev';
	public $dirs = array('www' => '/var/www', 'passwd' => '/etc/passwd');

	// Helper functions
	function isUser($user)
	{
		$passwd = $this->dirs['passwd'];
		return stristr(`cat $passwd`, $user);
	}

	function isEmail($email)
	{	
		if(!preg_match("/^[^@]{1,64}@[^@]{1,255}$/", $email))
			return false;
			
		// Split it into sections to make life easier
		$email_array = explode("@", $email);
		$local_array = explode(".", $email_array[0]);
		for($i = 0; $i < sizeof($local_array); $i++)
			if(!preg_match(":^(([A-Za-z0-9!#$%&'*+/=?^_`{|}~-][A-Za-z0-9!#$%&?'*+/=?^_`{|}~\.-]{0,63})|(\"[^(\\|\")]{0,62}\"))$:", $local_array[$i]))
				return false;

		if(!preg_match("/^\[?[0-9\.]+\]?$/", $email_array[1]))
		{
			$domain_array = explode(".", $email_array[1]);
			if(sizeof($domain_array) < 2)
				return false; // Not enough parts to domain
			for($i = 0; $i < sizeof($domain_array); $i++)
				if(!preg_match("/^(([A-Za-z0-9][A-Za-z0-9-]{0,61}[A-Za-z0-9])| ?([A-Za-z0-9]+))$/", $domain_array[$i]))
					return false;
		}
		return true;
	}

	function getPassword($len = 10)
	{
		$specials = '@#$%';
		$numbers = '1234567890';
		$letters = 'abcdefghijklmnopqrstuvwxyz';
		$capLetters = strtoupper($letters);
		
		$password = '';
		for($i = 0; $i < $len; $i++)
		{
			// Get the source at random (with smallest chance for special)
			$c = rand() % 33;
			if($c <= 10)
				$s = $letters;
			elseif($c <= 20)
				$s = $capLetters;
			elseif($c <= 29)
				$s = $numbers;
			else
				$s = $specials;
				
			$password .= $s[(rand() % strlen($s))];
		}
		return $password;
	}
	
	// Help function
	function help()
	{
		printf("Welcome to Omniashell version %s\n", $this->version);
		printf("  omniashell action user [-P <project>] [args...]\n");
		printf("  Where actions can be:\n");
		printf("   - devadd: Adds a dev user\n");
		printf("\n");
	}
	
	function devadd($user, $args)
	{
		// Check input
		if($this->isUser($user))
			die('User already exists');
		
		if(count($args) != 1)
			die('Wrong arg count');
		
		$email = $args[0];
		if(!$this->isEmail($email))
			die('Not a valid email');
			
		// Add user
		$password = $this->getPassword();
		$cmdUseradd = 'useradd -m -c "'.$email.'" -g '.$this->group.' -p '.$password.' '.$user;
		$cmdJailuser = 'jk_jailuser -m -j '.$this->dirs['www'].'/'.$user.' '.$user;
		
		
		
		printf("New user\n%s\n%s", $cmdUseradd, $cmdJailuser);
	}
}

// Create the shell
$shell = new Omniashell();

// Check basic arguments
if($argc <= 2 && $argv[1] != 'help')
{
	$shell->help();
	die("Not enough arguments");
}

// The main interperter
$cmd = strtolower($argv[1]);
$user = strtolower($argv[2]);
$project = ($argv[3] == '-P') ? strtolower($argv[4]) : null;
$args = array_slice($argv, (($argv[3] == '-P') ? 5 : 3));

switch($cmd)
{
	case 'help':
		$shell->help();
	break;
	case 'devadd':
		$shell->devadd($user, $args);
	break;
	default:
		printf("Not a valid command, see help.");
}
?>